<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Zoe: Offer-Safety Enforcement | Documentation</title>
    <meta name="description" content="Secure smart contracts">
    <link rel="icon" href="/documentation/favicon-full.ico">
  <script>
    const logoUrlChanger = setInterval(function() {
    //Anchor above the logo image
    const homeEls = document.getElementsByClassName("home-link");
    if(homeEls.length > 0) {
      const homeEl = homeEls[0];
      homeEl.setAttribute("href", "https://agoric.com");
      homeEl.setAttribute("onclick", "return false;");
      clearInterval(logoUrlChanger);
    }

    //Actual logo image
    const logoEls = document.getElementsByClassName("logo")
    if(logoEls.length > 0) {
      const logoEl = logoEls[0]
      logoEl.setAttribute("onclick", "document.location='https://agoric.com';return false;");
      clearInterval(logoUrlChanger);
    }
   }, 1000) </script>
    
    <link rel="preload" href="/documentation/assets/css/0.styles.67a138ae.css" as="style"><link rel="preload" href="/documentation/assets/js/app.ae92ee6b.js" as="script"><link rel="preload" href="/documentation/assets/js/2.a254c233.js" as="script"><link rel="preload" href="/documentation/assets/js/41.749825e2.js" as="script"><link rel="preload" href="/documentation/assets/js/10.68ff6144.js" as="script"><link rel="prefetch" href="/documentation/assets/js/11.df381bf0.js"><link rel="prefetch" href="/documentation/assets/js/12.c655e22b.js"><link rel="prefetch" href="/documentation/assets/js/13.0d89ddb0.js"><link rel="prefetch" href="/documentation/assets/js/14.f95b7a8b.js"><link rel="prefetch" href="/documentation/assets/js/15.87339499.js"><link rel="prefetch" href="/documentation/assets/js/16.54d3fc52.js"><link rel="prefetch" href="/documentation/assets/js/17.c68cedf0.js"><link rel="prefetch" href="/documentation/assets/js/18.5c67c8f7.js"><link rel="prefetch" href="/documentation/assets/js/19.79b98ca6.js"><link rel="prefetch" href="/documentation/assets/js/20.a1c151ab.js"><link rel="prefetch" href="/documentation/assets/js/21.afe8edca.js"><link rel="prefetch" href="/documentation/assets/js/22.baed0fb5.js"><link rel="prefetch" href="/documentation/assets/js/23.2fa1281c.js"><link rel="prefetch" href="/documentation/assets/js/24.a310dfd6.js"><link rel="prefetch" href="/documentation/assets/js/25.81ba4a2c.js"><link rel="prefetch" href="/documentation/assets/js/26.dd58deb0.js"><link rel="prefetch" href="/documentation/assets/js/27.9456125d.js"><link rel="prefetch" href="/documentation/assets/js/28.c7d71fa4.js"><link rel="prefetch" href="/documentation/assets/js/29.335dabbe.js"><link rel="prefetch" href="/documentation/assets/js/3.7a7bfb03.js"><link rel="prefetch" href="/documentation/assets/js/30.ee3a067e.js"><link rel="prefetch" href="/documentation/assets/js/31.db656ee8.js"><link rel="prefetch" href="/documentation/assets/js/32.a5f09512.js"><link rel="prefetch" href="/documentation/assets/js/33.a6986456.js"><link rel="prefetch" href="/documentation/assets/js/34.2972f39f.js"><link rel="prefetch" href="/documentation/assets/js/35.6b76be09.js"><link rel="prefetch" href="/documentation/assets/js/36.835622a2.js"><link rel="prefetch" href="/documentation/assets/js/37.b0a4354b.js"><link rel="prefetch" href="/documentation/assets/js/38.7bd12d92.js"><link rel="prefetch" href="/documentation/assets/js/39.4973eab0.js"><link rel="prefetch" href="/documentation/assets/js/4.ba1620b8.js"><link rel="prefetch" href="/documentation/assets/js/40.5767a1ea.js"><link rel="prefetch" href="/documentation/assets/js/42.350332a4.js"><link rel="prefetch" href="/documentation/assets/js/43.0e8e5572.js"><link rel="prefetch" href="/documentation/assets/js/44.e8f21bb8.js"><link rel="prefetch" href="/documentation/assets/js/45.9f83cdcf.js"><link rel="prefetch" href="/documentation/assets/js/46.29b510e0.js"><link rel="prefetch" href="/documentation/assets/js/47.6d4bc85e.js"><link rel="prefetch" href="/documentation/assets/js/48.ec7b0b97.js"><link rel="prefetch" href="/documentation/assets/js/49.f1803017.js"><link rel="prefetch" href="/documentation/assets/js/5.71c368ea.js"><link rel="prefetch" href="/documentation/assets/js/50.a35cffe9.js"><link rel="prefetch" href="/documentation/assets/js/51.f6951e5b.js"><link rel="prefetch" href="/documentation/assets/js/6.8d9d2e21.js"><link rel="prefetch" href="/documentation/assets/js/7.8c693afd.js"><link rel="prefetch" href="/documentation/assets/js/8.be72feb5.js"><link rel="prefetch" href="/documentation/assets/js/9.d38ae586.js">
    <link rel="stylesheet" href="/documentation/assets/css/0.styles.67a138ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/documentation/" class="home-link router-link-active"><img src="/documentation/logo.svg" alt="Documentation" class="logo"> <span class="site-name can-hide">Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started Menu" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/getting-started/" class="nav-link">Agoric Dev Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ERTP Menu" class="dropdown-title"><span class="title">ERTP</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/ertp/guide/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/documentation/ertp/api/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Agoric/agoric-sdk/tree/master/packages/ERTP" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Zoe Menu" class="dropdown-title"><span class="title">Zoe</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/zoe/guide/" class="nav-link router-link-exact-active router-link-active">Guide</a></li><li class="dropdown-item"><!----> <a href="/documentation/zoe/guide/contracts/autoswap.html" class="nav-link">Contracts</a></li><li class="dropdown-item"><!----> <a href="/documentation/zoe/api/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Agoric/agoric-sdk/tree/master/packages/zoe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/documentation/dapps/" class="nav-link">Dapp Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Learn More Menu" class="dropdown-title"><span class="title">Learn More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/miscellaneous/contributing.html" class="nav-link">Contributing</a></li><li class="dropdown-item"><!----> <a href="https://agoric.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Agoric
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Agoric/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started Menu" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/getting-started/" class="nav-link">Agoric Dev Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ERTP Menu" class="dropdown-title"><span class="title">ERTP</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/ertp/guide/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/documentation/ertp/api/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Agoric/agoric-sdk/tree/master/packages/ERTP" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Zoe Menu" class="dropdown-title"><span class="title">Zoe</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/zoe/guide/" class="nav-link router-link-exact-active router-link-active">Guide</a></li><li class="dropdown-item"><!----> <a href="/documentation/zoe/guide/contracts/autoswap.html" class="nav-link">Contracts</a></li><li class="dropdown-item"><!----> <a href="/documentation/zoe/api/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Agoric/agoric-sdk/tree/master/packages/zoe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/documentation/dapps/" class="nav-link">Dapp Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Learn More Menu" class="dropdown-title"><span class="title">Learn More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/documentation/miscellaneous/contributing.html" class="nav-link">Contributing</a></li><li class="dropdown-item"><!----> <a href="https://agoric.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Agoric
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Agoric/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/documentation/zoe/guide/" class="sidebar-heading clickable router-link-exact-active router-link-active open active"><span>Zoe</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/documentation/zoe/guide/" class="active sidebar-link">Zoe: Offer-Safety Enforcement</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/documentation/zoe/guide/#what-is-zoe" class="sidebar-link">What is Zoe?</a></li><li class="sidebar-sub-header"><a href="/documentation/zoe/guide/#sounds-like-magic-how-does-it-actually-work" class="sidebar-link">Sounds like magic. How does it actually work?</a></li><li class="sidebar-sub-header"><a href="/documentation/zoe/guide/#an-example-a-swap" class="sidebar-link">An example: A swap</a></li><li class="sidebar-sub-header"><a href="/documentation/zoe/guide/#how-to-write-smart-contracts" class="sidebar-link">How to write smart contracts</a></li><li class="sidebar-sub-header"><a href="/documentation/zoe/guide/#diving-deeper" class="sidebar-link">Diving Deeper</a></li></ul></li><li><a href="/documentation/zoe/guide/offer-safety.html" class="sidebar-link">Offer Safety</a></li><li><a href="/documentation/zoe/guide/proposal.html" class="sidebar-link">The Structure of Proposals</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/documentation/zoe/guide/contracts/" class="sidebar-heading clickable"><span>Zoe Contracts</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/documentation/zoe/guide/contracts/atomic-swap.html" class="sidebar-link">Atomic Swap</a></li><li><a href="/documentation/zoe/guide/contracts/autoswap.html" class="sidebar-link">AutoSwap</a></li><li><a href="/documentation/zoe/guide/contracts/covered-call.html" class="sidebar-link">Covered Call</a></li><li><a href="/documentation/zoe/guide/contracts/second-price-auction.html" class="sidebar-link">Second-price auction</a></li><li><a href="/documentation/zoe/guide/contracts/simple-exchange.html" class="sidebar-link">Simple Exchange</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/documentation/zoe/api/" class="sidebar-heading clickable"><span>Zoe API</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/documentation/zoe/api/zoe.html" class="sidebar-link">Zoe</a></li><li><a href="/documentation/zoe/api/records.html" class="sidebar-link">Records</a></li><li><a href="/documentation/zoe/api/zoe-contract-facet.html" class="sidebar-link">Zoe Contract Facet</a></li><li><a href="/documentation/zoe/api/zoe-helpers.html" class="sidebar-link">ZoeHelpers</a></li></ul></section></li><li><a href="/documentation/zoe/roadmap/" class="sidebar-link">Zoe Roadmap</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="zoe-offer-safety-enforcement"><a href="#zoe-offer-safety-enforcement" class="header-anchor">#</a> Zoe: Offer-Safety Enforcement</h1> <div class="zoe-version">
    Zoe v0.3.0. Last updated
    3/24/2020.
</div> <p>Note: Zoe is currently at the pre-alpha stage. It has not yet been
formally tested or hardened.</p> <p>This guide assumes some knowledge of the <a href="/documentation/ertp/guide/">ERTP
fundamentals</a>.</p> <h2 id="what-is-zoe"><a href="#what-is-zoe" class="header-anchor">#</a> What is Zoe?</h2> <p><strong>For users</strong>: Zoe guarantees that as a user of a smart contract, you
will either get what you wanted or get a full refund, even if the
smart contract is buggy or malicious. (In fact, the smart contract
never has access to your digital assets.)</p> <p><strong>For developers</strong>: Zoe provides a safety net so you can focus on what
your smart contract does best, without worrying about your users
losing their assets due to a bug in the code that you wrote. Writing a
smart contract on Zoe is easy: all of the Zoe smart contracts are
written in the familiar language of JavaScript.</p> <h2 id="sounds-like-magic-how-does-it-actually-work"><a href="#sounds-like-magic-how-does-it-actually-work" class="header-anchor">#</a> Sounds like magic. How does it actually work?</h2> <p>To use Zoe, we put things in terms of &quot;offers&quot;. An offer proposal is a
statement about what you want and what you're willing to offer. It
turns out, many smart contracts (apart from gifts and one-way
payments) involve an exchange of digital assets that can be put in
terms of offer proposals.</p> <p>In this version of Zoe, our offer proposals are simple (see <a href="/documentation/zoe/roadmap/">our
roadmap</a> for more complex proposal types). We
can say things like, &quot;I'll give you <a href="https://en.wikipedia.org/wiki/Catan" target="_blank" rel="noopener noreferrer">three wood for two
bricks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.&quot; <a href="/documentation/zoe/guide/proposal.html">Learn more about the
particulars of structuring an offer proposal here</a>.</p> <p>Offers are a structured way of describing user intent. To a certain
extent, an offer's rules (called a <em>proposal</em>) are the user's
<em>contractual understanding</em> of the agreement they are entering into.
You might have noticed that the offer doesn't specify the mechanism by
which the exchange happens. The offer doesn't say whether the item you
want is up for auction, in an exchange, or part of a private trade.
The offer doesn't mention the particular mechanism because an
important part of the design of Zoe is a <strong>separation of concerns</strong>.
Zoe is responsible for enforcing what we call &quot;offer safety&quot;, and the
smart contract that runs on top of Zoe is responsible for figuring out
a proposed reallocation of resources. To use an auction as an example,
the smart contract is responsible for figuring out who wins the
auction and how much they pay, but Zoe handles the escrowing of the
bids and the payments. You can think of this as similar to e-commerce
websites using a separate payment-processor so that they don't have to
handle the credit cards themselves.</p> <h3 id="what-is-offer-safety"><a href="#what-is-offer-safety" class="header-anchor">#</a> What is &quot;offer safety&quot;?</h3> <p>Zoe guarantees offer safety, meaning that when a user makes an offer
that is escrowed with Zoe, Zoe guarantees that the user will either
get back why they said they wanted, or the user will get back what they
originally offered.</p> <p>When a user escrows with Zoe, they get two things back immediately: a
<code>seat</code>, and a JavaScript promise for a future payout. This <code>seat</code> has
methods that the user can call to take action in the smart contract on
Zoe, without the smart contract ever having access to the underlying
digital assets. Let's look a particular example to see how this works.</p> <h2 id="an-example-a-swap"><a href="#an-example-a-swap" class="header-anchor">#</a> An example: A swap</h2> <p>I want to trade my three bricks for five wool. You realize you have
five wool and agree to the deal. Without Zoe, though, you might send
me the five wool, and I might disappear without ever giving you the
three bricks in return. With Zoe, we can safely trade with each other,
even if we don't trust one another. We are assured that at worst, if
the swap contract behaves badly, we will both get a refund, and at
best, we'll get what we each wanted.</p> <p>Let's look at the basic <code>atomicSwap</code> contract (<a href="https://github.com/Agoric/agoric-sdk/blob/master/packages/zoe/src/contracts/atomicSwap.js" target="_blank" rel="noopener noreferrer">full text of
the real contract<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p>Here's a high-level overview of what would happen:</p> <ol><li>I make an instance of the swap contract.</li> <li>I escrow my three bricks with Zoe. In return, I get a seat at the contract and a promise for a payout.</li> <li>I use my seat to make the first offer in the swap, and I get back
an invite to send to you to be the counter-party.</li> <li>You inspect the invite and verify that it was created using the
<code>atomicSwap</code> contract code.</li> <li>You use your invite to escrow your offer (offering five wool for
three bricks) with Zoe, getting a seat and a promise for a payout
in return.</li> <li>You use your seat to make a matching offer.</li> <li>The offer matches and both of our payout promises resolve, mine to
the five wool that I wanted, and yours to the three bricks that you
wanted. Success!</li></ol> <h2 id="how-to-write-smart-contracts"><a href="#how-to-write-smart-contracts" class="header-anchor">#</a> How to write smart contracts</h2> <p>Writing smart contracts that run on Zoe is easy, but let's look
at a simple contract. This contract only does one thing, and
it's pretty useless - it gives you back what you put in. Let's call it
<code>automaticRefund</code>. Let's say the code of <code>automaticRefund</code> looks like
this (see the <a href="https://github.com/Agoric/agoric-sdk/blob/master/packages/zoe/src/contracts/automaticRefund.js" target="_blank" rel="noopener noreferrer">real contract code
here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">makeContract</span> <span class="token operator">=</span> <span class="token parameter">zoe</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">makeSeatInvite</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> seat <span class="token operator">=</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">makeOffer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        zoe<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inviteHandle<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The offer was accepted</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> invite<span class="token punctuation">,</span> inviteHandle <span class="token punctuation">}</span> <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">makeInvite</span><span class="token punctuation">(</span>seat<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      seatDesc<span class="token operator">:</span> <span class="token string">'getRefund'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> invite<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    invite<span class="token operator">:</span> <span class="token function">makeSeatInvite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicAPI<span class="token operator">:</span> <span class="token punctuation">{</span>
      makeInvite<span class="token operator">:</span> makeSeatInvite<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>(In a real contract, whenever we create a new object or array, we recursively
deep-freeze it with <code>@agoric/harden</code>. You can <a href="https://github.com/Agoric/harden" target="_blank" rel="noopener noreferrer">learn more about <code>harden</code> here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.)</p> <p><code>automaticRefund</code> has one method exposed to the user: <code>makeOffer</code>.
<code>makeOffer</code> tells Zoe to complete the offer, which gives the user their payout through Zoe.</p> <p>A smart contract on Zoe must export a function <code>makeContract</code> that
takes a single parameters: <code>zoe</code>, which is the contract-specific API
for Zoe. The smart contract must return an object with two
properties:
<code>invite</code>, an invite to join the contract which will be given to the
user who instantiated the contract and <code>publicAPI</code>, the public API to the
contract (no invite necessary to call these methods!).</p> <h2 id="diving-deeper"><a href="#diving-deeper" class="header-anchor">#</a> Diving Deeper</h2> <p>To get a better idea of the usual control flow, let's look at a more
complex smart contract, such as the <code>atomicSwap</code> contract that we
mentioned earlier. Someone needs to make the first offer, so let's
make sure our user-facing API has a method for that:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">makeFirstOfferInvite</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> seat <span class="token operator">=</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">makeFirstOffer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> expected <span class="token operator">=</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">{</span> give<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Asset'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> want<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Price'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rejectIfNotProposal</span><span class="token punctuation">(</span>inviteHandle<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">makeMatchingInvite</span><span class="token punctuation">(</span>inviteHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> invite<span class="token punctuation">,</span> inviteHandle <span class="token punctuation">}</span> <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">makeInvite</span><span class="token punctuation">(</span>seat<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      seatDesc<span class="token operator">:</span> <span class="token string">'firstOffer'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> invite<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>This is pretty similar in format to the <code>automaticRefund</code>, but there
are a few changes. First, in this contract, we actually check what was
escrowed with Zoe to see if it's the kind of offer that we want to
accept. In this case, we only want to accept offers that have a
proposal of the form:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span> give<span class="token operator">:</span> <span class="token punctuation">{</span> Asset<span class="token operator">:</span> amount1<span class="token punctuation">,</span> want<span class="token operator">:</span> <span class="token punctuation">{</span> Price<span class="token operator">:</span> amount2 <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre></div><p>where <code>amount1</code> and <code>amount2</code> are amounts with the correct issuers.</p> <p>Also, this is a swap, so we can't immediately return a payout to the
user who puts in the first offer; we have to wait for a valid matching
offer. So, if we get a valid first offer, we create an invite which can be shared with other parties to create a matching offer.</p> <p>So, how does the matching happen? We can look at another user-facing
method, <code>makeMatchingInvite</code>, and a helper function, <code>swap</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">makeMatchingInvite</span> <span class="token operator">=</span> <span class="token parameter">firstInviteHandle</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> seat <span class="token operator">=</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">matchOffer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">swap</span><span class="token punctuation">(</span>firstInviteHandle<span class="token punctuation">,</span> inviteHandle<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    proposal<span class="token operator">:</span> <span class="token punctuation">{</span> want<span class="token punctuation">,</span> give <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">getOffer</span><span class="token punctuation">(</span>firstInviteHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> invite<span class="token punctuation">,</span> inviteHandle <span class="token punctuation">}</span> <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">makeInvite</span><span class="token punctuation">(</span>seat<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    asset<span class="token operator">:</span> give<span class="token punctuation">.</span>Asset<span class="token punctuation">,</span>
    price<span class="token operator">:</span> want<span class="token punctuation">.</span>Price<span class="token punctuation">,</span>
    seatDesc<span class="token operator">:</span> <span class="token string">'matchOffer'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> invite<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>swap<span class="token operator">:</span> <span class="token punctuation">(</span>
  keepHandle<span class="token punctuation">,</span>
  tryHandle<span class="token punctuation">,</span>
  keepHandleInactiveMsg <span class="token operator">=</span> <span class="token string">'prior offer is unavailable'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>zoe<span class="token punctuation">.</span><span class="token function">isOfferActive</span><span class="token punctuation">(</span>keepHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> helpers<span class="token punctuation">.</span><span class="token function">rejectOffer</span><span class="token punctuation">(</span>tryHandle<span class="token punctuation">,</span> keepHandleInactiveMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>helpers<span class="token punctuation">.</span><span class="token function">canTradeWith</span><span class="token punctuation">(</span>keepHandle<span class="token punctuation">,</span> tryHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> helpers<span class="token punctuation">.</span><span class="token function">rejectOffer</span><span class="token punctuation">(</span>tryHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> keepAmounts <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">getOffer</span><span class="token punctuation">(</span>keepHandle<span class="token punctuation">)</span><span class="token punctuation">.</span>amounts<span class="token punctuation">;</span>
  <span class="token keyword">const</span> tryAmounts <span class="token operator">=</span> zoe<span class="token punctuation">.</span><span class="token function">getOffer</span><span class="token punctuation">(</span>tryHandle<span class="token punctuation">)</span><span class="token punctuation">.</span>amounts<span class="token punctuation">;</span>
  <span class="token comment">// reallocate by switching the amount</span>
  <span class="token keyword">const</span> handles <span class="token operator">=</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">[</span>keepHandle<span class="token punctuation">,</span> tryHandle<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  zoe<span class="token punctuation">.</span><span class="token function">reallocate</span><span class="token punctuation">(</span>handles<span class="token punctuation">,</span> <span class="token function">harden</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tryAmounts<span class="token punctuation">,</span> keepAmounts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  zoe<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>handles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defaultAcceptanceMsg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the <code>makeMatchingInvite</code> method we call <code>swap</code>, which handles a lot of the logic. First, <code>swap</code> checks if the offer is still active. If not, we reject the offer at
hand. Second, if the offer at hand isn't a match for the first offer,
we want to reject it for that reason as well.</p> <p>Once we're sure that we <em>do</em> have a matching offer, we can do the most
exciting part, the reallocation.</p> <p>Smart contracts on Zoe have no access to the underlying
digital assets, but they can ask Zoe for information on what was
escrowed for each offer. That information is in the form of an
<code>amount</code>, which is a labeled extent. For instance, in &quot;3 bricks&quot;, &quot;3&quot; is
the extent, and &quot;bricks&quot; is the label. (<a href="/documentation/ertp/guide/">See more about ERTP fundamentals here</a>).</p> <p>Because this is a swap, we want to literally swap the amounts for the
first offer and the matching offer. That is, the user who put in the
first offer will get what the second user put in and vice versa. <code>swap</code> makes a call to <code>zoe.reallocate</code> in order to tell Zoe about this reallocation for the two offers.</p> <p>Zoe checks two invariants before changing its bookkeeping. First, Zoe
checks that offer safety holds for these offers. In other words, does
this reallocation either give a refund or give the user what they
wanted? Second, Zoe checks that asset supply is conserved. This means
that we haven't lost or added any digital assets on the whole as a
result of this reallocation.</p> <p>If the reallocation passes, we can tell Zoe to complete the offers and
send out payouts with a call to <code>zoe.complete</code>. Note that we can
reallocate without completing offers, or complete without
reallocating, depending on the logic of the contract.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/documentation/zoe/guide/offer-safety.html">Offer Safety</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/documentation/assets/js/app.ae92ee6b.js" defer></script><script src="/documentation/assets/js/2.a254c233.js" defer></script><script src="/documentation/assets/js/41.749825e2.js" defer></script><script src="/documentation/assets/js/10.68ff6144.js" defer></script>
  </body>
</html>
